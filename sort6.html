<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>An example of a minimal, extensible table sort</title>
  
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  
  <script type="text/javascript" src="http://madhatted.com/assets/2008/1/11/mootools-release-1.11.js"></script>
  <script type="text/javascript" language="JavaScript"><!-- <![CDATA[

//
// new SortingTable( 'my_table', {
//   zebra: true,     // Stripe the table, also on initialize
//   details: false   // Has details every other row
// });
//
// The above were the defaults.  The regexes in load_conversions test a cell
// begin sorted for a match, then use that conversion for all elements on that
// column.
//
// Requires mootools Class, Array, Function, Element, Element.Selectors,
// Element.Event, and you should probably get Window.DomReady if you're smart.
//

var SortingTable = new Class({

  initialize: function( table, options ) {
    this.options = $merge({
      zebra: true,
      details: false
    }, options);
    
    this.table = $(table);
    
    this.tbody = $(this.table.getElementsByTagName('tbody')[0]);
    if (this.options.zebra) {
      SortingTable.stripe_table( this.tbody.getElements( 'tr' ) );
    }

    this.headers = new Hash;
    var thead = $(this.table.getElementsByTagName('thead')[0]);
    $each(thead.getElementsByTagName('tr')[0].getElementsByTagName('th'), function( header, index ) {
      var header = $(header);
      this.headers.set( header.getText(), { column: index } );
      header.addEvent( 'mousedown', function(evt){
        var evt = new Event(evt);
        this.sort_by_header( evt.target.getText() );
      }.bind( this ) );
    }.bind( this ) );

    this.load_conversions();
  },

  sort_by_header: function( header_text ){
    this.rows = new Array;
    var trs = this.tbody.getElements( 'tr' );
    while ( trs.length > 0 ) {
      var row = { row: trs.shift().remove() };
      if ( this.options.details ) {
        row.detail = trs.shift().remove();
      }
      this.rows.unshift( row );
    }
    
    var header = this.headers.get( header_text );
    if ( this.sort_column >= 0 && this.sort_column == header.column ) {
      // They were pulled off in reverse
    } else {
      this.sort_column = header.column;
      if (header.conversion_function) {
        this.conversion_function = header.conversion_function;
      } else {
        this.conversion_function = false;
        this.rows.some(function(row){
          var to_match = $(row.row.getElementsByTagName('td')[this.sort_column]).getText();
          if (to_match == ''){ return false }
          this.conversions.some(function(conversion){
            if (conversion.matcher.test( to_match )){
              this.conversion_function = conversion.conversion_function;
              return true;
            }
            return false;
          }.bind( this ));
          if (this.conversion_function){ return true; }
          return false;
        }.bind( this ));
        header.conversion_function = this.conversion_function.bind( this );
        this.headers.set( header_text, header );
      }
      this.rows.each(function(row){
        row.compare_value = this.conversion_function( row );
      }.bind( this ));
      this.rows.sort( this.compare_rows.bind( this ) );
    }

    var index = 0;
    while (this.rows.length > 0) {
      var row = this.rows.shift();
      row.row.injectInside( this.tbody );
      if (row.detail){ row.detail.injectInside( this.tbody ) };
      if ( this.options.zebra ) {
        row.row.removeClass( 'alt' );
        if (row.detail){ row.detail.removeClass( 'alt' ); }
        if ( ( index % 2 ) == 0 ) {
          row.row.addClass( 'alt' );
          if (row.detail){ row.detail.addClass( 'alt' ); }
        }
      }
      index++;
    }
    this.rows = false;
  },

  compare_rows: function( r1, r2 ) {
    if ( r1.compare_value > r2.compare_value ) { return  1 }
    if ( r1.compare_value < r2.compare_value ) { return -1 }
    return 0;
  },
  
  load_conversions: function() {
    this.conversions = $A([
      // YYYY-MM-DD, YYYY-m-d
      { matcher: /\d{4}-\d{1,2}-\d{1,2}/,
        conversion_function: function( row ) {
          var cell = $(row.row.getElementsByTagName('td')[this.sort_column]).getText();
          var re = /(\d{4})-(\d{1,2})-(\d{1,2})/;
          cell = re.exec( cell );
          return new Date(parseInt(cell[1]), parseInt(cell[2], 10) - 1, parseInt(cell[3], 10));
        }
      },
      // Fallback 
      { matcher: /.*/,
        conversion_function: function( row ) {
          return $(row.row.getElementsByTagName('td')[this.sort_column]).getText();
        }
      }
    ]);
  }

});

SortingTable.stripe_table = function ( tr_elements  ) {
  var counter = 0;
  $$( tr_elements ).each( function( tr ) {
    if ( tr.style.display != 'none' && !tr.hasClass('collapsed') ) {
      counter++;
    }
    tr.removeClass( 'alt' );   
    if ( !(( counter % 2 ) == 0) ) {
      tr.addClass( 'alt' );   
    }
  }.bind( this ));
}
// ]]> --></script>
<style type="text/css">
body{
  font-size   :76%;
  font-family :Verdana, Helvetica; }
div#example_1 table, div#example_2 table {
  font-size   :1.0em; }
table {
  text-align: left; }
table thead tr th {
  padding     :2px 4px;
  background  :#d7d7d7;
  border-bottom:1px solid black; }
table tbody tr td {
  padding     :2px 4px; }
table tbody tr.alt {
  background  :#e8f3e8; }
table tbody tr.collapsed td {
  padding     :0px; }
table tbody tr.collapsed td div {
  font-family :Serif;
  white-space :pre;
  font-size   :1.0em;
  margin-left :10px; }
</style>
</head>
<body>

<div id="header">
This is an example of a minimal javascript sort based on <a href="http://www.mootools.net/">mootools</a>.  There is a <a href="http://madhatted.com/2008/1/11/the-joy-of-a-minimal-complete-javascript-table-sort">blog posting</a> the goes with this page.
</div>

<div id="example_1">
<h2>A sorting table that uses a minimal javascript</h2>

<table cellpadding="0" cellspacing="0" id="example_1_table">
  <thead>
  <tr>
    <th>Name</th>
    <th>Birthday</th>
    <th>Timezone</th>
    <th>Birthplace</th>
    <th>Sign</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td>Alexander Pope</td>
    <td>May 21st, 1688</td>
    <td>GMT</td>
    <td>London, England</td>
    <td>Taurus</td>
  </tr>
  <tr>
    <td>Percy Bysshe Shelley</td>
    <td>August 4th, 1792</td>
    <td>GMT</td>
    <td>Horsham, England</td>
    <td>Leo</td>
  </tr>
  <tr>
    <td>Sara Teasdale</td>
    <td>August 8th, 1884</td>
    <td>CST</td>
    <td>St. Louis, MS</td>
    <td>Leo</td>
  </tr>
  <tr>
    <td>Pablo Neruda</td>
    <td>July 12th, 1904</td>
    <td>CLT</td>
    <td>Parral, Chile</td>
    <td>Cancer</td>
  </tr>
  </tbody>
</table>
<script type="text/javascript">
window.addEvent( 'domready', function(){
  new SortingTable( 'example_1_table' );
});
</script>
</div>

<div id="example_2">
<h2>A sorting table with collapsed rows</h2>

<table cellpadding="0" cellspacing="0" id="example_2_table">
  <thead>
  <tr>
    <th>Name</th>
    <th>Birthday</th>
    <th>Timezone</th>
    <th>Birthplace</th>
    <th>Sign</th>
  </tr>
  </thead>
  <tbody>
  <tr>
    <td><a href="#" id="pope">Alexander Pope</a></td>
    <td>May 21st, 1688</td>
    <td>GMT</td>
    <td>London, England</td>
    <td>Taurus</td>
  </tr>
  <tr class="collapsed">
    <td colspan="5">
      <div class="collapsed" id="pope_details">
Now wits gain praise by copying other wits
As one Hog lives on what another sh---.
      </div>
    </td>
  </tr>
  <tr>
    <td><a href="#" id="shelley">Percy Bysshe Shelley</a></td>
    <td>August 4th, 1792</td>
    <td>GMT</td>
    <td>Horsham, England</td>
    <td>Leo</td>
  </tr>
  <tr class="collapsed">
    <td colspan="5">
      <div class="collapsed" id="shelley_details">
O WORLD! O life! O time!
On whose last steps I climb,
Trembling at that where I had stood before;
When will return the glory of your prime?
No more -- oh, never more!
      </div>
    </td>
  </tr>
  <tr>
    <td><a href="#" id="teasdale">Sara Teasdale</a></td>
    <td>August 8th, 1884</td>
    <td>CST</td>
    <td>St. Louis, MS</td>
    <td>Leo</td>
  </tr>
  <tr class="collapsed">
    <td colspan="5">
      <div class="collapsed" id="teasdale_details">
What do I care, in the dreams and the languor of spring,
That my songs do not show me at all?
For they are a fragrance, and I am a flint and a fire,
I am an answer, they are only a call.
      </div>
    </td>
  </tr>
  <tr>
    <td><a href="#" id="neruda">Pablo Neruda</a></td>
    <td>July 12th, 1904</td>
    <td>CLT</td>
    <td>Parral, Chile</td>
    <td>Cancer</td>
  </tr>
  <tr class="collapsed">
    <td colspan="5">
      <div class="collapsed" id="neruda_details">
Leaning into the afternoons I cast my sad nets
towards your oceanic eyes.

There in the highest blaze my solitude lengthens and flames,
its arms turning like a drowning man's.
      </div>
    </td>
  </tr>
  </tbody>
</table>
<script type="text/javascript">
// This fancy expando table needs a few more things from mootools: Fx.Style,
// Fx.Slide, Hash, Element.Events
//
window.addEvent( 'domready', function(){
    
window.effects = new Hash;
$each([ 'pope', 'shelley', 'teasdale', 'neruda' ], function( id ){
  window.effects.set(id, new Fx.Slide( id+'_details' ).hide() );
  $(id).addEvent( 'mousedown', function(evt){
    window.effects.get(id).toggle();
    return false;
  }.bind( this ));
}.bind( this ));

new SortingTable( 'example_2_table', { details: true } );
});
</script>
</div>

</body>
</table>
